<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ms. Ni çš„ P6Aä¸­æ–‡èª²å ‚</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Hanzi Writer -->
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* å¼•å…¥è‡ªå®šç¾©å­—é«” */
        @font-face {
            font-family: 'FreeHKKai';
            src: url('Free-HK-Kai_4700-v1.02.ttf') format('truetype');
            font-display: swap;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden; /* å¼·åˆ¶éš±è—æ²è»¸ */
            overscroll-behavior: none;
            margin: 0;
            padding: 0;
        }
        
        /* è¨­å®šå…¨åŸŸå­—é«”ç‚ºè‡ªå®šç¾©å­—é«”ï¼Œè‹¥è¼‰å…¥å¤±æ•—å‰‡é€€å›å…¶ä»–æ¨™æ¥·é«” */
        body {
            font-family: 'FreeHKKai', "BiaoKai", "DFKai-SB", "Kaiti TC", "STKaiti", "KaiTi", serif;
            background-color: #fff1f2;
            background-image: radial-gradient(#fecdd3 15%, transparent 16%), radial-gradient(#fecdd3 15%, transparent 16%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            touch-action: pan-x pan-y;
        }
        /* å¼·åˆ¶è¦†è“‹æ‰€æœ‰å…ƒç´ çš„å­—é«” */
        .calligraphy-font, .font-serif, .font-sans, .font-mono, button, input, h1, h2, h3, h4, h5, h6, p, span, div {
            font-family: 'FreeHKKai', "BiaoKai", "DFKai-SB", "Kaiti TC", "STKaiti", "KaiTi", serif !important;
        }

        .mizige {
            background-color: white;
            background-image: 
                linear-gradient(45deg, transparent 49.5%, #fee2e2 49.5%, #fee2e2 50.5%, transparent 50.5%),
                linear-gradient(-45deg, transparent 49.5%, #fee2e2 49.5%, #fee2e2 50.5%, transparent 50.5%),
                linear-gradient(to right, transparent 49.5%, #ef4444 49.5%, #ef4444 50.5%, transparent 50.5%),
                linear-gradient(to bottom, transparent 49.5%, #ef4444 49.5%, #ef4444 50.5%, transparent 50.5%);
            background-size: 100% 100%;
            border: 3px solid #f43f5e;
            border-radius: 12px;
            touch-action: none !important; 
        }
        
        @keyframes pop-up {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop-up {
            animation: pop-up 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes float-up-fade {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            50% { opacity: 1; transform: translateY(-15px) scale(1.2); }
            100% { opacity: 0; transform: translateY(-30px) scale(1); }
        }
        .animate-float-deduction {
            animation: float-up-fade 0.8s ease-out forwards;
        }

        .demo-canvas svg {
            width: 100% !important;
            height: 100% !important;
        }
        
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body>
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ==========================================
        // æ•¸æ“šçµæ§‹è¨­å®šå€
        // ==========================================
        
        // --- ç¬¬1æ¬¡é»˜æ›¸ ---
        const P6_VOCAB_DICTATION_1 = [
            { id: 101, word: "ç…©æ‚¶", emoji: "ğŸ˜«", jyutping: "faan4 mun6", pinyin: "fÃ¡n mÃ¨n", meaning: "å¿ƒæƒ…ä¸æš¢å¿«ï¼Œå¿ƒç…©ã€‚", english_meaning: "Vexed; Depressed.", sentence: "ä¸‹é›¨å¤©ä¸èƒ½å‡ºå»ç©ï¼Œæ„Ÿåˆ°ååˆ†____ã€‚", tip: "ã€Œç…©ã€å­—å³é‚Šæ˜¯é ã€‚" },
            { id: 102, word: "å¾˜å¾Š", emoji: "ğŸš¶", jyutping: "pui4 wui4", pinyin: "pÃ¡i huÃ¡i", meaning: "åœ¨ä¸€å€‹åœ°æ–¹ä¾†å›èµ°å‹•ã€‚", english_meaning: "Pace back and forth; Linger.", sentence: "ä»–åœ¨æ ¡é–€å£____ï¼Œå¥½åƒåœ¨ç­‰äººã€‚", tip: "å…©å€‹å­—éƒ½æ˜¯é›™äººæ—ã€‚" },
            { id: 103, word: "ç¹å¯†", emoji: "ğŸŒ³", jyutping: "faan4 mat6", pinyin: "fÃ¡n mÃ¬", meaning: "å¤šè€Œå¯†ã€‚", english_meaning: "Dense; Thick.", sentence: "æ£®æ—è£¡æè‘‰____ï¼Œé™½å…‰å¾ˆé›£é€é€²ä¾†ã€‚", tip: "ã€Œç¹ã€å­—ä¸‹é¢æ˜¯çºŸã€‚" },
            { id: 104, word: "é®è”½", emoji: "ğŸ™ˆ", jyutping: "ze1 bai3", pinyin: "zhÄ“ bÃ¬", meaning: "é®æ“‹ï¼›æ””æ“‹ã€‚", english_meaning: "To cover; To hide.", sentence: "çƒé›²____äº†å¤©ç©ºï¼Œå¿«è¦ä¸‹é›¨äº†ã€‚", tip: "ã€Œè”½ã€å­—æ˜¯è‰èŠ±é ­ã€‚" },
            { id: 105, word: "å–š", emoji: "ğŸ—£ï¸", jyutping: "wun6", pinyin: "huÃ n", meaning: "å«ï¼›å‘¼å–šã€‚", english_meaning: "Call out; Summon.", sentence: "åª½åª½åœ¨æ¨“ä¸‹å¤§è²å‘¼____æˆ‘å›å®¶åƒé£¯ã€‚", tip: "å£å­—æ—ï¼Œå³é‚Šæ˜¯å¥ã€‚" },
            { id: 106, word: "å½·å½¿", emoji: "ğŸ¤”", jyutping: "fong2 fat1", pinyin: "fÇng fÃº", meaning: "ä¼¼ä¹ï¼›å¥½åƒã€‚", english_meaning: "Seemingly; As if.", sentence: "é€™è²éŸ³è½èµ·ä¾†____åœ¨å“ªè£¡è½éã€‚", tip: "å…©å€‹å­—éƒ½æ˜¯é›™äººæ—ã€‚" },
            { id: 107, word: "éœå¯‚", emoji: "ğŸ¤«", jyutping: "zing6 zik6", pinyin: "jÃ¬ng jÃ¬", meaning: "éå¸¸å®‰éœï¼Œæ²’æœ‰è²éŸ³ã€‚", english_meaning: "Silent; Still.", sentence: "å¤œæ·±äº†ï¼Œå››å‘¨ä¸€ç‰‡____ã€‚", tip: "ã€Œå¯‚ã€å­—æ˜¯å¯¶è“‹é ­ã€‚" },
            { id: 108, word: "å¯†ä½ˆ", emoji: "â˜ï¸", jyutping: "mat6 bou3", pinyin: "mÃ¬ bÃ¹", meaning: "ç¨ å¯†åœ°åˆ†ä½ˆã€‚", english_meaning: "Densely covered.", sentence: "å¤©ç©ºçƒé›²____ï¼Œä¸€å ´æš´é›¨å³å°‡ä¾†è‡¨ã€‚", tip: "ã€Œä½ˆã€å­—æ˜¯äººå­—æ—ã€‚" },
            { id: 109, word: "çœ¨çœ¼", emoji: "ğŸ˜‰", jyutping: "zaap3 ngaan5", pinyin: "zhÇ yÇn", meaning: "çœ¼ç›å¾ˆå¿«åœ°é–‰ä¸€ä¸‹åˆçœé–‹ã€‚", english_meaning: "Blink.", sentence: "æ™‚é–“éå¾—çœŸå¿«ï¼Œä¸€____å°±ç•¢æ¥­äº†ã€‚", tip: "éƒ½æ˜¯ç›®å­—æ—ã€‚" },
            { id: 110, word: "æ‡·æŠ±", emoji: "ğŸ¤—", jyutping: "waai4 pou5", pinyin: "huÃ¡i bÃ o", meaning: "æŠ±åœ¨æ‡·è£¡ï¼›èƒ¸å‰ã€‚", english_meaning: "Embrace; Bosom.", sentence: "å¬°å…’åœ¨æ¯è¦ªæº«æš–çš„____è£¡ç¡è‘—äº†ã€‚", tip: "éƒ½æ˜¯ææ‰‹æ—ã€‚" }
        ];

        const P6_SENTENCE_DICTATION_1 = {
            id: 'sent_1',
            title: "å¥å­ç·´ç¿’",
            content: "æ¼¸æ¼¸åœ°æˆ‘çš„çœ¼ç›æ¨¡ç³Šäº†ï¼Œæˆ‘å°±åƒçœ‹è¦‹ç„¡æ•¸çš„è¢ç«èŸ²åœ¨æˆ‘å‘¨åœé£›èˆã€‚æµ·ä¸Šçš„å¤œæ˜¯æŸ”å’Œçš„ï¼Œæ˜¯éœå¯‚çš„ï¼Œæ˜¯å¤¢å¹»çš„ã€‚"
        };

        const P6_IDIOMS_DICTATION_1 = [
            { id: 201, word: "ç„¡è™•ä¸åœ¨", jyutping: "mou4 cyu3 bat1 zoi6", pinyin: "wÃº chÃ¹ bÃ¹ zÃ i", meaning: "åˆ°è™•éƒ½æœ‰ï¼Œå½¢å®¹å¾ˆå¤šã€‚", english_meaning: "Everywhere; Ubiquitous.", sentence: "éš¨è‘—ç§‘æŠ€é€²æ­¥ï¼Œç¶²çµ¡ä¿¡è™Ÿå¹¾ä¹____ã€‚" },
            { id: 202, word: "æ–æ–æ¬²å¢œ", jyutping: "jiu4 jiu4 juk6 zeoi6", pinyin: "yÃ¡o yÃ¡o yÃ¹ zhuÃ¬", meaning: "å½¢å®¹éå¸¸å±éšªï¼Œå¿«è¦æ‰ä¸‹ä¾†æˆ–å€’å¡Œã€‚", english_meaning: "Tottering; Precarious; On the verge of collapse.", sentence: "é‚£åº§èˆŠæ©‹ç¶“æ­·äº†æ´ªæ°´å¾Œï¼Œè®Šå¾—____ã€‚" },
            { id: 203, word: "èƒ¸æœ‰æˆç«¹", jyutping: "hung1 jau5 sing4 zuk1", pinyin: "xiÅng yÇ’u chÃ©ng zhÃº", meaning: "æ¯”å–»åšäº‹ä¹‹å‰å·²ç¶“æœ‰é€šç›¤çš„è€ƒæ…®ã€‚", english_meaning: "Confident; Have a well-thought-out plan.", sentence: "å°æ–¼é€™æ¬¡çš„è€ƒè©¦ï¼Œä»–æ—©å·²è¤‡ç¿’å¥½ï¼Œé¡¯å¾—____ã€‚" },
            { id: 204, word: "è‡ªç›¸çŸ›ç›¾", jyutping: "zi6 soeng1 maau4 teon5", pinyin: "zÃ¬ xiÄng mÃ¡o dÃ¹n", meaning: "æ¯”å–»è‡ªå·±çš„è¨€èªæˆ–è¡Œç‚ºå‰å¾ŒæŠµè§¸ã€‚", english_meaning: "Self-contradictory.", sentence: "ä½ å‰›æ‰èªªä¸æƒ³å»ï¼Œç¾åœ¨åˆèªªè¦å»ï¼Œé€™ä¸æ˜¯____å—ï¼Ÿ" },
            { id: 205, word: "è‘‰å…¬å¥½é¾", jyutping: "jip6 gung1 hou3 lung4", pinyin: "yÃ¨ gÅng hÃ o lÃ³ng", meaning: "æ¯”å–»è¡¨é¢ä¸Šæ„›å¥½æŸäº‹ç‰©ï¼Œå¯¦éš›ä¸Šä¸¦ä¸çœŸæ‡‚æˆ–ä¸¦ä¸çœŸå–œæ­¡ã€‚", english_meaning: "Professed love of what one does not really understand or fear.", sentence: "ä»–é›–ç„¶èªªå–œæ­¡éœ²ç‡Ÿï¼Œä½†ä¸€è½åˆ°æœ‰èŸ²å­å°±åš‡è·‘äº†ï¼ŒçœŸæ˜¯____ã€‚" }
        ];

        // --- ç¬¬2æ¬¡é»˜æ›¸ ---
        const P6_VOCAB_DICTATION_2 = [
            { id: 301, word: "å›‚å¼µ", emoji: "ğŸ˜¤", jyutping: "hiu1 zoeng1", pinyin: "xiÄo zhÄng", meaning: "æ”¾è‚†ï¼›é‚ªæƒ¡ä¹‹æ°£é«˜æ¼²ã€‚", english_meaning: "Arrogant; Rampant.", sentence: "é‚£æ­¹å¾’æ°£ç„°____ï¼Œç«Ÿæ•¢åœ¨å…‰å¤©åŒ–æ—¥ä¸‹æ¶åŠ«ã€‚", tip: "ã€Œå›‚ã€å­—æœ‰å››å€‹å£ã€‚" },
            { id: 302, word: "èƒ¸æœ‰æˆç«¹", emoji: "ğŸ‹", jyutping: "hung1 jau5 sing4 zuk1", pinyin: "xiÅng yÇ’u chÃ©ng zhÃº", meaning: "æ¯”å–»åšäº‹ä¹‹å‰å·²ç¶“æœ‰é€šç›¤çš„è€ƒæ…®ã€‚", english_meaning: "Confident; Have a plan.", sentence: "å°æ–¼é€™æ¬¡æ¯”è³½ï¼Œä»–____ï¼Œä¿¡å¿ƒåè¶³ã€‚", tip: "å››å­—æˆèªï¼Œå½¢å®¹è‡ªä¿¡ã€‚" },
            { id: 303, word: "é£Ÿè¨€", emoji: "ğŸ™Š", jyutping: "sik6 jin4", pinyin: "shÃ­ yÃ¡n", meaning: "ä¸å®ˆä¿¡ç”¨ï¼›ä¸å±¥è¡Œè«¾è¨€ã€‚", english_meaning: "Break a promise.", sentence: "åšäººè¦è¬›ä¿¡ç”¨ï¼Œä¸å¯____è€Œè‚¥ã€‚", tip: "æ„æ€åƒæŠŠè©±åƒå›å»ã€‚" },
            { id: 304, word: "ç‘•ç–µ", emoji: "ğŸ’", jyutping: "haa4 ci1", pinyin: "xiÃ¡ cÄ«", meaning: "ç‰ä¸Šçš„æ–‘é»ï¼›æ¯”å–»ç¼ºé»æˆ–æ¯›ç—…ã€‚", english_meaning: "Flaw; Blemish.", sentence: "é€™å¡Šç‰çŸ³é›–ç„¶ç¾ï¼Œä½†æœ‰ä¸€é»å°____ã€‚", tip: "å…©å€‹å­—éƒ½æ˜¯ç‹å­—æ—ã€‚" },
            { id: 305, word: "ç›®çªå£å‘†", emoji: "ğŸ˜²", jyutping: "muk6 dang6 hau2 ngoi4", pinyin: "mÃ¹ dÃ¨ng kÇ’u dÄi", meaning: "å½¢å®¹å—é©šè€Œæ„£ä½çš„æ¨£å­ã€‚", english_meaning: "Stunned; Dumbfounded.", sentence: "çœ‹åˆ°é€™é©šäººçš„é­”è¡“ï¼Œè§€çœ¾å€‘éƒ½____ã€‚", tip: "å½¢å®¹é©šè¨çš„è¡¨æƒ…ã€‚" },
            { id: 306, word: "å¾—æ„æ´‹æ´‹", emoji: "ğŸ˜", jyutping: "dak1 ji3 joeng4 joeng4", pinyin: "dÃ© yÃ¬ yÃ¡ng yÃ¡ng", meaning: "å½¢å®¹ååˆ†å¾—æ„çš„æ¨£å­ã€‚", english_meaning: "Triumphant; Complacent.", sentence: "ä»–è€ƒäº†ç¬¬ä¸€åï¼Œ____åœ°æ‹¿è‘—è€ƒå·å›å®¶ã€‚", tip: "ã€Œæ´‹æ´‹ã€å½¢å®¹æ¨£å­ã€‚" },
            { id: 307, word: "å°ˆå¿ƒè‡´å¿—", emoji: "ğŸ§ ", jyutping: "zyun1 sam1 zi3 zi3", pinyin: "zhuÄn xÄ«n zhÃ¬ zhÃ¬", meaning: "ä¸€å¿ƒä¸€æ„ï¼›é›†ä¸­ç²¾ç¥ã€‚", english_meaning: "Wholly absorbed; Devoted.", sentence: "åŒå­¸å€‘éƒ½åœ¨åœ–æ›¸é¤¨____åœ°æº«ç¿’åŠŸèª²ã€‚", tip: "è‡´å¿—ï¼šè‡´åŠ›æ–¼æŸäº‹ã€‚" },
            { id: 308, word: "å‚²æ…¢", emoji: "ğŸ˜’", jyutping: "ngou6 maan6", pinyin: "Ã o mÃ n", meaning: "é©•å‚²ç„¡ç¦®ã€‚", english_meaning: "Arrogant; Haughty.", sentence: "ä»–æ…‹åº¦____ï¼Œä¸æŠŠåˆ¥äººæ”¾åœ¨çœ¼è£¡ã€‚", tip: "ã€Œå‚²ã€æ˜¯å–®äººæ—ã€‚" },
            { id: 309, word: "èªé‡å¿ƒé•·", emoji: "ğŸ—£ï¸", jyutping: "jyu5 zung6 sam1 coeng4", pinyin: "yÇ” zhÃ²ng xÄ«n chÃ¡ng", meaning: "è¨€èªèª æ‡‡ï¼Œæƒ…æ„æ·±é•·ã€‚", english_meaning: "Meaningful and earnest.", sentence: "è€å¸«____åœ°å‹¸å°æˆ‘å€‘è¦çæƒœæ™‚é–“ã€‚", tip: "å½¢å®¹èªªè©±æ‡‡åˆ‡ã€‚" }
        ];

        const P6_SENTENCE_DICTATION_2 = {
            id: 'sent_2',
            title: "å¥å­ç·´ç¿’",
            content: "ç§¦ç‹é›™æ‰‹æ§è‘—å’Œæ°ç’§ï¼Œæ„›ä¸é‡‹æ‰‹ï¼Œçœ¾è‡£å°å’Œæ°ç’§è®šä¸çµ•å£ã€‚å¤©é‚„æ²’äº®ï¼Œå››å‘¨éœæ‚„æ‚„çš„ï¼Œåªæœ‰æ±æ–¹éœ²å‡ºä¸€çµ²äº®å…‰ã€‚"
        };

        const P6_IDIOMS_DICTATION_2 = [
            { id: 401, word: "å®Œç’§æ­¸è¶™", jyutping: "jyun4 bik1 gwai1 ziu6", pinyin: "wÃ¡n bÃ¬ guÄ« zhÃ o", meaning: "æ¯”å–»æŠŠåŸç‰©å®Œå¥½åœ°æ­¸é‚„æœ¬äººã€‚", english_meaning: "Return something intact to its owner.", sentence: "æˆ‘å€Ÿä½ çš„æ›¸ï¼Œçœ‹å®Œå¾Œä¸€å®š____ã€‚" },
            { id: 402, word: "ç†ç›´æ°£å£¯", jyutping: "lei5 zik6 hei3 zong3", pinyin: "lÇ zhÃ­ qÃ¬ zhuÃ ng", meaning: "ç†ç”±å……åˆ†ï¼Œèªªè©±æ°£å‹¢å°±å£¯ç››ã€‚", english_meaning: "Bold and confident with justice on one's side.", sentence: "ä»–è¦ºå¾—è‡ªå·±æ²’åšéŒ¯ï¼Œæ‰€ä»¥____åœ°åé§ã€‚" },
            { id: 403, word: "è£è…”ä½œå‹¢", jyutping: "zong1 hong1 zok3 sai3", pinyin: "zhuÄng qiÄng zuÃ² shÃ¬", meaning: "æ•…æ„åšä½œæƒ³å¼•äººæ³¨æ„æˆ–åš‡å”¬äººã€‚", english_meaning: "Put on an act; Posture.", sentence: "åˆ¥ç†ä»–ï¼Œä»–åªæ˜¯åœ¨____ç½·äº†ã€‚" },
            { id: 404, word: "ä¸çŸ¥æ‰€æª", jyutping: "bat1 zi1 so2 cou3", pinyin: "bÃ¹ zhÄ« suÇ’ cuÃ²", meaning: "ä¸çŸ¥é“è©²æ€éº¼è¾¦ã€‚", english_meaning: "At a loss; Wits' end.", sentence: "çªå¦‚å…¶ä¾†çš„å£æ¶ˆæ¯è®“ä»–____ã€‚" },
            { id: 405, word: "å¼·è©å¥ªç†", jyutping: "koeng5 ci4 dyut6 lei5", pinyin: "qiÇng cÃ­ duÃ³ lÇ", meaning: "æœ¬ç„¡é“ç†å»å¼·è¡Œç‹¡è¾¯ã€‚", english_meaning: "Twist logic; Sophistry.", sentence: "æ˜æ˜æ˜¯ä»–é²åˆ°ï¼Œå»é‚„____èªªæ˜¯é¬§é˜å£äº†ã€‚" }
        ];

        // --- ç¬¬3æ¬¡é»˜æ›¸ ---
        const P6_VOCAB_DICTATION_3 = [
            { id: 501, word: "éˆæ„Ÿ", emoji: "ğŸ’¡", jyutping: "ling4 gam2", pinyin: "lÃ­ng gÇn", meaning: "åœ¨æ–‡è—ã€ç§‘å­¸å‰µé€ éç¨‹ä¸­ï¼Œçªç„¶çˆ†ç™¼çš„æ€ç¶­æ´»å‹•ã€‚", english_meaning: "Inspiration.", sentence: "ç•«å®¶å¾å¤§è‡ªç„¶ä¸­å°‹æ‰¾å‰µä½œ____ã€‚", tip: "ã€Œéˆã€å­—ä¸‹é¢æ˜¯ç«ã€‚" },
            { id: 502, word: "é ˜æ‚Ÿ", emoji: "ğŸ§ ", jyutping: "ling5 ng6", pinyin: "lÇng wÃ¹", meaning: "é ˜æœƒï¼›ç†è§£ã€‚", english_meaning: "Comprehend; Grasp.", sentence: "ç¶“éè€å¸«çš„è¬›è§£ï¼Œæˆ‘çµ‚æ–¼____äº†é€™é“é¡Œçš„è§£æ³•ã€‚", tip: "ã€Œæ‚Ÿã€æ˜¯è±å¿ƒæ—ã€‚" },
            { id: 503, word: "è³‡ç”¢", emoji: "ğŸ’°", jyutping: "zi1 caan2", pinyin: "zÄ« chÇn", meaning: "è²¡ç”¢ã€‚", english_meaning: "Asset; Property.", sentence: "å¥åº·æ˜¯æˆ‘å€‘äººç”Ÿæœ€å¤§çš„____ã€‚", tip: "ã€Œè³‡ã€å­—ä¸‹é¢æ˜¯è²ã€‚" },
            { id: 504, word: "è¨€ä¹‹æœ‰ç‰©", emoji: "ğŸ—£ï¸", jyutping: "jin4 zi1 jau5 mat6", pinyin: "yÃ¡n zhÄ« yÇ’u wÃ¹", meaning: "æ–‡ç« æˆ–èªªè©±å…§å®¹å…·é«”å……å¯¦ã€‚", english_meaning: "Have substance in speech/writing.", sentence: "é€™ç¯‡æ¼”è¬›ç¨¿____ï¼Œè½çœ¾ç²ç›Šè‰¯å¤šã€‚", tip: "å½¢å®¹èªªè©±æœ‰å…§å®¹ã€‚" },
            { id: 505, word: "ä¸‹ç­†æˆç« ", emoji: "âœï¸", jyutping: "haa6 bat1 sing4 zoeng1", pinyin: "xiÃ  bÇ chÃ©ng zhÄng", meaning: "å½¢å®¹æ–‡æ€æ•æ·ï¼Œä¸€ä¸‹ç­†å°±èƒ½å¯«æˆæ–‡ç« ã€‚", english_meaning: "Write quickly and well.", sentence: "ä»–æ‰è¯æ©«æº¢ï¼Œå¯«ä½œæ™‚å¾€å¾€____ã€‚", tip: "å½¢å®¹å¯«ä½œå¿«ã€‚" },
            { id: 506, word: "ç„¡å½±ç„¡è¹¤", emoji: "ğŸ‘»", jyutping: "mou4 jing2 mou4 zung1", pinyin: "wÃº yÇng wÃº zÅng", meaning: "å®Œå…¨æ¶ˆå¤±ï¼Œä¸çŸ¥å»å‘ã€‚", english_meaning: "Disappear without a trace.", sentence: "å°å·ä¸€æºœç…™è·‘å¾—____ã€‚", tip: "é€£å½±å­è¹¤è·¡éƒ½æ²’äº†ã€‚" },
            { id: 507, word: "ç¨€å¥‡å¤æ€ª", emoji: "ğŸ‘½", jyutping: "hei1 kei4 gu2 gwaai3", pinyin: "xÄ« qÃ­ gÇ” guÃ i", meaning: "å¾ˆå°‘è¦‹ï¼Œå¾ˆå¥‡ç•°ï¼Œä¸åŒä¸€èˆ¬ã€‚", english_meaning: "Bizarre; Eccentric.", sentence: "é€™å®¶åº—è³£è¨±å¤š____çš„å°ç©æ„å…’ã€‚", tip: "å½¢å®¹å¥‡æ€ªçš„äº‹ç‰©ã€‚" },
            { id: 508, word: "æ—¥æ–°æœˆç•°", emoji: "ğŸ“…", jyutping: "jat6 san1 jyut6 ji6", pinyin: "rÃ¬ xÄ«n yuÃ¨ yÃ¬", meaning: "æ¯å¤©æ¯æœˆéƒ½æœ‰æ–°çš„è®ŠåŒ–ã€‚å½¢å®¹é€²æ­¥ç™¼å±•å¾ˆå¿«ã€‚", english_meaning: "Change rapidly.", sentence: "ç§‘æŠ€ç™¼å±•____ï¼Œæ™ºèƒ½æ‰‹æ©ŸåŠŸèƒ½è¶Šä¾†è¶Šå¼·å¤§ã€‚", tip: "æ—¥æ—¥æ–°ï¼Œæœˆæœˆç•°ã€‚" },
            { id: 509, word: "å•Ÿç™¼", emoji: "âœ¨", jyutping: "kai2 faat3", pinyin: "qÇ fÄ", meaning: "é—¡æ˜äº‹ä¾‹ï¼Œå¼•èµ·å°æ–¹è¯æƒ³è€Œæœ‰æ‰€é ˜æ‚Ÿã€‚", english_meaning: "Inspire; Enlighten.", sentence: "é€™æœ¬å‚³è¨˜çµ¦äº†æˆ‘å¾ˆå¤§____ã€‚", tip: "ã€Œå•Ÿã€å­—æ˜¯æˆ¶å­—é ­ã€‚" },
            { id: 510, word: "ç–‘åœ˜", emoji: "â“", jyutping: "ji4 tyun4", pinyin: "yÃ­ tuÃ¡n", meaning: "è¨±å¤šç©åœ¨å¿ƒè£¡ä¸è§£çš„ç–‘å•ã€‚", english_meaning: "Doubts; Suspicions.", sentence: "çœŸç›¸å¤§ç™½å¾Œï¼Œå¿ƒä¸­çš„____çµ‚æ–¼è§£é–‹äº†ã€‚", tip: "åƒåœ˜ä¸€æ¨£çš„ç–‘å•ã€‚" }
        ];

        // èª²æ–‡ (ä½œç‚ºæˆèªè™•ç†)
        const P6_IDIOMS_DICTATION_3 = [
            { id: 601, word: "æ±Ÿéƒæ‰ç›¡", jyutping: "gong1 long4 coi4 zeon6", pinyin: "jiÄng lÃ¡ng cÃ¡i jÃ¬n", meaning: "æ¯”å–»æ‰æ€æ¯ç«­ã€‚", english_meaning: "Use up one's literary talent.", sentence: "é€™ä½ä½œå®¶è¿‘å¹´ä½œå“å¹³å¹³ï¼Œä¼¼æœ‰____ä¹‹æ„Ÿã€‚" },
            { id: 602, word: "ä¾ç„¶æ•…æˆ‘", jyutping: "ji1 jin4 gu3 ngo5", pinyin: "yÄ« rÃ¡n gÃ¹ wÇ’", meaning: "å½¢å®¹è‡ªå·±ä»èˆŠåƒå¾å‰ä¸€æ¨£ï¼Œæ²’æœ‰æ”¹è®Šã€‚", english_meaning: "Remain the same old self.", sentence: "å„˜ç®¡åˆ¥äººæ€éº¼å‹¸èªªï¼Œä»–é‚„æ˜¯____ï¼Œä¸è‚¯æ”¹éã€‚" },
            { id: 603, word: "è³è‡‚æ“‹è»Š", jyutping: "tong4 bei3 dong2 ce1", pinyin: "tÃ¡ng bÃ¬ dÇng chÄ“", meaning: "æ¯”å–»ä¸è‡ªé‡åŠ›ã€‚", english_meaning: "Overrate oneself; Try to stop a carriage with mantis arms.", sentence: "ä½ æƒ³æ†‘ä¸€äººä¹‹åŠ›å°æŠ—å¤§è²¡åœ˜ï¼Œç°¡ç›´æ˜¯____ã€‚" },
            { id: 604, word: "è² èŠè«‹ç½ª", jyutping: "fu6 ging1 cing2 zeoi6", pinyin: "fÃ¹ jÄ«ng qÇng zuÃ¬", meaning: "èƒŒè‘—èŠæ¢å‘å°æ–¹è«‹ç½ªã€‚è¡¨ç¤ºå‘äººèªéŒ¯è³ ç½ªã€‚", english_meaning: "Offer humble apology.", sentence: "å»‰é —çŸ¥é“è‡ªå·±éŒ¯æ€ªäº†è—ºç›¸å¦‚ï¼Œä¾¿ç™»é–€____ã€‚" },
            { id: 605, word: "è¶¾é«˜æ°£æš", jyutping: "zi2 gou1 hei3 joeng4", pinyin: "zhÇ gÄo qÃ¬ yÃ¡ng", meaning: "å½¢å®¹é©•å‚²è‡ªå¤§ï¼Œå¾—æ„å¿˜å½¢çš„æ¨£å­ã€‚", english_meaning: "Arrogant; Elated.", sentence: "ç²å‹çš„éšŠä¼____åœ°èµ°éè¬›å°ã€‚" }
        ];

        // é»ƒé¶´æ¨“ (ä½œç‚ºå¥å­è™•ç†)
        const P6_SENTENCE_DICTATION_3 = {
            id: 'sent_3',
            title: "é»ƒé¶´æ¨“ (è©©è©)",
            content: "æ˜”äººå·²ä¹˜é»ƒé¶´å»ï¼Œæ­¤åœ°ç©ºé¤˜é»ƒé¶´æ¨“ã€‚é»ƒé¶´ä¸€å»ä¸å¾©è¿”ï¼Œç™½é›²åƒè¼‰ç©ºæ‚ æ‚ ã€‚æ™´å·æ­·æ­·æ¼¢é™½æ¨¹ï¼ŒèŠ³è‰è‹è‹é¸šéµ¡æ´²ã€‚æ—¥æš®é„‰é—œä½•è™•æ˜¯ï¼Ÿç…™æ³¢æ±Ÿä¸Šä½¿äººæ„ã€‚"
        };

        const FILE_SYSTEM = {
            id: 'root',
            title: "ä¸»ç›®éŒ„",
            type: 'folder',
            children: [
                {
                    id: 'dictation',
                    title: "é»˜æ›¸ Dictation",
                    subtitle: "P6A é‡é»è©•ä¼°",
                    type: 'folder',
                    icon: "ph-book-bookmark",
                    children: [
                        {
                            id: 'dictation_1',
                            title: "ç¬¬1æ¬¡ (1st)",
                            subtitle: "ç¯„åœï¼šç¬¬ä¹ã€åèª²",
                            type: 'folder',
                            icon: "ph-folder-open",
                            children: [
                                {
                                    id: 'd1_vocab',
                                    title: "è©èª Vocab",
                                    type: 'file',
                                    fileType: 'vocab',
                                    icon: "ph-file-text",
                                    data: P6_VOCAB_DICTATION_1
                                },
                                {
                                    id: 'd1_sentence',
                                    title: "å¥å­ Sentences",
                                    type: 'file',
                                    fileType: 'sentence',
                                    icon: "ph-text-aa",
                                    data: P6_SENTENCE_DICTATION_1
                                },
                                {
                                    id: 'd1_idioms',
                                    title: "æˆèª Idioms",
                                    type: 'file',
                                    fileType: 'idiom',
                                    icon: "ph-scroll",
                                    data: P6_IDIOMS_DICTATION_1
                                }
                            ]
                        },
                        {
                            id: 'dictation_2',
                            title: "ç¬¬2æ¬¡ (2nd)",
                            subtitle: "ç¯„åœï¼šè©èªã€å¥å­ã€æˆèª",
                            type: 'folder',
                            icon: "ph-folder-open",
                            children: [
                                {
                                    id: 'd2_vocab',
                                    title: "è©èª Vocab",
                                    type: 'file',
                                    fileType: 'vocab',
                                    icon: "ph-file-text",
                                    data: P6_VOCAB_DICTATION_2
                                },
                                {
                                    id: 'd2_sentence',
                                    title: "å¥å­ Sentences",
                                    type: 'file',
                                    fileType: 'sentence',
                                    icon: "ph-text-aa",
                                    data: P6_SENTENCE_DICTATION_2
                                },
                                {
                                    id: 'd2_idioms',
                                    title: "æˆèª Idioms",
                                    type: 'file',
                                    fileType: 'idiom',
                                    icon: "ph-scroll",
                                    data: P6_IDIOMS_DICTATION_2
                                }
                            ] 
                        },
                        {
                            id: 'dictation_3',
                            title: "ç¬¬3æ¬¡ (3rd)",
                            subtitle: "ç¯„åœï¼šè©èªã€èª²æ–‡æˆèªã€é»ƒé¶´æ¨“",
                            type: 'folder',
                            icon: "ph-folder-open",
                            children: [
                                {
                                    id: 'd3_vocab',
                                    title: "è©èª Vocab",
                                    type: 'file',
                                    fileType: 'vocab',
                                    icon: "ph-file-text",
                                    data: P6_VOCAB_DICTATION_3
                                },
                                {
                                    id: 'd3_idioms',
                                    title: "èª²æ–‡ (æˆèª) Idioms",
                                    type: 'file',
                                    fileType: 'idiom',
                                    icon: "ph-scroll",
                                    data: P6_IDIOMS_DICTATION_3
                                },
                                {
                                    id: 'd3_sentence',
                                    title: "é»ƒé¶´æ¨“ (è©©è©) Poem",
                                    type: 'file',
                                    fileType: 'sentence',
                                    icon: "ph-scroll",
                                    data: P6_SENTENCE_DICTATION_3
                                }
                            ]
                        }
                    ]
                }
            ]
        };

        const speak = (text, lang = 'zh-HK') => {
            if (!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang;
            utterance.rate = 0.8;
            window.speechSynthesis.speak(utterance);
        };

        const StrokeDemoModal = ({ word, onComplete }) => {
            const containerRef = useRef(null);
            const writersRef = useRef([]); 
            const [isLoaded, setIsLoaded] = useState(false);
            const [isPlaying, setIsPlaying] = useState(false);
            const [speed, setSpeed] = useState(1);
            const speedRef = useRef(1);

            useEffect(() => { speedRef.current = speed; }, [speed]);

            useEffect(() => {
                if (!containerRef.current) return;
                containerRef.current.innerHTML = '';
                writersRef.current = [];
                setIsLoaded(false);

                const chars = word.split('');
                const size = Math.min(100, (window.innerWidth - 60) / chars.length);
                let loadedCount = 0;
                const totalChars = chars.length;

                chars.forEach(char => {
                    const div = document.createElement('div');
                    div.style.width = `${size}px`;
                    div.style.height = `${size}px`;
                    div.className = "mizige demo-canvas";
                    containerRef.current.appendChild(div);
                    
                    if (!char.match(/[\u4e00-\u9fa5]/)) {
                         div.innerHTML = `<div style="display:flex;justify-content:center;align-items:center;height:100%;font-size:${size*0.5}px;">${char}</div>`;
                         loadedCount++;
                         if (loadedCount === totalChars) setIsLoaded(true);
                         return;
                    }

                    const writer = HanziWriter.create(div, char, {
                        width: size, height: size, padding: 5,
                        strokeColor: '#0369a1',
                        delayBetweenStrokes: 150,
                        showOutline: true,
                        showCharacter: false, 
                        onLoadCharDataSuccess: () => { loadedCount++; if (loadedCount === totalChars) setIsLoaded(true); },
                        onLoadCharDataError: () => { loadedCount++; if (loadedCount === totalChars) setIsLoaded(true); }
                    });
                    writersRef.current.push(writer);
                });
                
                if (writersRef.current.length === 0 && totalChars > 0) setIsLoaded(true);
            }, [word]);

            const playAnimation = async () => {
                if (isPlaying || !isLoaded) return;
                setIsPlaying(true);
                for (const writer of writersRef.current) {
                    writer.hideCharacter();
                    await writer.animateCharacter({ speed: speedRef.current });
                }
                setIsPlaying(false);
            };

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-lg animate-pop-up border-4 border-rose-200">
                        <div className="text-center mb-2">
                            <h3 className="text-2xl font-bold text-rose-600 mb-1">ğŸ‘€ ç­†é †è§€å¯Ÿå®¤</h3>
                            <p className="text-lg font-bold text-gray-800">{word}</p>
                        </div>
                        <div className="bg-rose-50 border-l-4 border-rose-400 p-2 mb-4 rounded text-sm text-rose-800 font-bold">
                            âš ï¸ æ³¨æ„ï¼šé—œé–‰å¾Œç„¡æ³•å†æ¬¡è§€çœ‹ï¼<br/>
                            <span className="text-xs text-rose-600 font-normal">Note: You cannot replay this after closing!</span>
                        </div>
                        <div className="min-h-[120px] mb-4 relative">
                            <div ref={containerRef} className="w-full h-full flex justify-center items-center gap-1"></div>
                            {!isLoaded && <div className="absolute inset-0 z-10 flex justify-center items-center bg-white/80 text-gray-400 gap-2"><i className="ph ph-spinner animate-spin"></i> è¼‰å…¥ç­†é †ä¸­...</div>}
                        </div>
                        <div className="flex justify-center gap-2 mb-4">
                            <span className="text-gray-500 font-bold text-sm flex items-center">é€Ÿåº¦ Speed:</span>
                            {[0.5, 1, 2].map((s) => (
                                <button key={s} onClick={() => setSpeed(s)} className={`px-3 py-1 rounded-full text-xs font-bold transition border ${speed === s ? 'bg-rose-500 text-white border-rose-500 shadow-sm' : 'bg-white text-gray-500 border-gray-200 hover:bg-gray-50'}`}>{s === 0.5 ? 'æ…¢ (Slow)' : s === 1 ? 'æ­£å¸¸ (Normal)' : 'å¿« (Fast)'}</button>
                            ))}
                        </div>
                        <div className="flex gap-3">
                            <button onClick={playAnimation} disabled={isPlaying || !isLoaded} className={`flex-1 py-3 rounded-xl font-bold text-white shadow-md transition ${(isPlaying || !isLoaded) ? 'bg-gray-300' : 'bg-sky-400 hover:bg-sky-500'}`}>{!isLoaded ? 'è¼‰å…¥ä¸­ Loading...' : (isPlaying ? 'æ¼”ç¤ºä¸­ Playing...' : 'â–¶ï¸ æ’­æ”¾ç­†é † Play')}</button>
                            <button onClick={onComplete} className="flex-1 py-3 bg-rose-500 hover:bg-rose-600 text-white rounded-xl font-bold shadow-md transition">é—œé–‰ä¸¦é–‹å§‹ Close & Start</button>
                        </div>
                    </div>
                </div>
            );
        };

        const CharacterBox = ({ char, onScoreChange, resetSignal, onComplete, sizeOverride }) => {
            const boxRef = useRef(null);
            const writerRef = useRef(null);
            const [localScore, setLocalScore] = useState(100);
            const [status, setStatus] = useState('ready'); 
            const [boxSize, setBoxSize] = useState(150); 
            const [deductionKey, setDeductionKey] = useState(0);

            useEffect(() => {
                const updateSize = () => {
                    if (sizeOverride) { setBoxSize(sizeOverride); return; }
                    
                    const width = window.innerWidth;
                    const height = window.innerHeight;
                    let availableH = height - 220; 
                    let availableW = width < 768 ? width - 40 : (width * 0.45);
                    let target = Math.min(availableH, availableW);
                    
                    if (width < 640) target = Math.min((width - 40) / 2.5, availableH / 2);

                    target = Math.min(target, 160); 
                    target = Math.max(target, 80); 
                    
                    setBoxSize(target);
                };
                updateSize(); 
                window.addEventListener('resize', updateSize); 
                return () => window.removeEventListener('resize', updateSize);
            }, [sizeOverride]);

            useEffect(() => {
                if (boxRef.current && window.HanziWriter && char.match(/[\u4e00-\u9fa5]/)) {
                    boxRef.current.innerHTML = "";
                    setLocalScore(100);
                    setStatus('ready');
                    try {
                        writerRef.current = HanziWriter.create(boxRef.current, char, {
                            width: boxSize, height: boxSize, padding: 3,
                            showOutline: true, showCharacter: false, showHintAfterMisses: 1, 
                            strokeColor: '#0369a1', outlineColor: '#cbd5e1', highlightColor: '#10b981', 
                        });
                        startQuiz();
                    } catch (e) { if (onComplete) onComplete(); }
                } else if (boxRef.current && !char.match(/[\u4e00-\u9fa5]/)) {
                    boxRef.current.innerHTML = `<div style="display:flex;justify-content:center;align-items:center;height:100%;font-size:${boxSize*0.5}px;">${char}</div>`;
                    if (onComplete) setTimeout(onComplete, 200); 
                }
            }, [char, resetSignal, boxSize]);

            const startQuiz = () => {
                if (!writerRef.current) return;
                setStatus('writing');
                writerRef.current.quiz({
                    onMistake: () => {
                        setDeductionKey(Date.now());
                        setLocalScore(p => { 
                            const n = Math.max(0, p - 10); 
                            onScoreChange(char, n); 
                            return n; 
                        });
                    },
                    onComplete: () => {
                        setStatus('scoring');
                        setTimeout(() => {
                            setStatus('show_char');
                            if(writerRef.current) writerRef.current.showCharacter({ animation: false });
                        }, 1000); 
                        if (onComplete) onComplete();
                    }
                });
            };

            return (
                <div className="flex flex-col items-center m-1">
                    <div className="relative shadow-md group transform transition hover:scale-105 border-2 border-gray-100 rounded-xl">
                        <div className={`mizige relative overflow-hidden bg-white cursor-crosshair writing-canvas-container ${status === 'show_char' ? 'border-emerald-400 bg-emerald-50' : ''}`}
                             style={{ width: `${boxSize}px`, height: `${boxSize}px` }}>
                            <div ref={boxRef} className="absolute inset-0 w-full h-full flex justify-center items-center svg-container"></div>
                            {deductionKey > 0 && <div key={deductionKey} className="absolute top-2 right-2 text-red-600 font-bold text-2xl z-30 animate-float-deduction pointer-events-none" style={{ textShadow: '2px 2px 0px rgba(255,255,255,0.8)' }}>-10</div>}
                            {status === 'scoring' && <div className="absolute inset-0 flex items-center justify-center pointer-events-none fade-in z-20"><div className="border-2 border-red-500 rounded-full flex items-center justify-center bg-white/90 shadow-sm" style={{ width: `${boxSize * 0.7}px`, height: `${boxSize * 0.7}px` }}><span className="block text-red-600 font-bold" style={{ fontSize: `${boxSize * 0.3}px` }}>{localScore}</span></div></div>}
                        </div>
                    </div>
                </div>
            );
        };

        const WordPractice = ({ wordData, onWordComplete, onScoreUpdate }) => {
            const chars = wordData.word.split('');
            const [resetSignal, setResetSignal] = useState(0);
            const [scores, setScores] = useState({});
            const [completedIndices, setCompletedIndices] = useState(new Set());
            const [showDemo, setShowDemo] = useState(true); 

            const handleScoreChangeIndexed = (index, score) => setScores(p => ({ ...p, [index]: score }));
            const handleCharComplete = (index) => {
                setCompletedIndices(p => {
                    const n = new Set(p); n.add(index);
                    if (n.size === chars.length) onWordComplete(true);
                    return n;
                });
            };
            const calculateAverage = () => {
                const total = Object.values(scores).reduce((a, b) => a + b, 0);
                return chars.length === 0 ? 0 : Math.round(total / chars.length);
            };

            useEffect(() => { if (onScoreUpdate) onScoreUpdate(calculateAverage()); }, [scores]);
            useEffect(() => {
                const i = {}; chars.forEach((_, x) => i[x] = 100); setScores(i); setCompletedIndices(new Set());
                setShowDemo(true); 
            }, [wordData]);

            if (showDemo) return <StrokeDemoModal word={wordData.word} onComplete={() => setShowDemo(false)} />;

            return (
                <div className="flex flex-col items-center justify-center w-full h-full py-2">
                    <div className="w-full flex justify-between items-center bg-white/80 backdrop-blur px-4 py-2 rounded-xl mb-2 border border-rose-100 shadow-sm max-w-md shrink-0">
                         <span className="text-xs text-rose-500 font-bold uppercase tracking-wider">ç•¶å‰å¾—åˆ† Score</span>
                         <span className="text-3xl font-bold text-rose-600 font-mono">{calculateAverage()}</span>
                    </div>
                    
                    <div className="flex-1 flex items-center justify-center w-full min-h-0">
                        <div className="flex flex-wrap justify-center gap-2 content-center">
                            {chars.map((char, index) => (
                                <CharacterBox key={`${wordData.id}-${index}-${char}`} char={char} resetSignal={resetSignal}
                                    onScoreChange={(c, s) => handleScoreChangeIndexed(index, s)} onComplete={() => handleCharComplete(index)} />
                            ))}
                        </div>
                    </div>
                    
                    <div className="mt-2 shrink-0">
                        <button onClick={() => { setResetSignal(p => p + 1); const i = {}; chars.forEach((_, x) => i[x] = 100); setScores(i); setCompletedIndices(new Set()); onWordComplete(false); }}
                            className="px-6 py-2 bg-slate-100 text-slate-600 rounded-full hover:bg-slate-200 text-sm font-bold transition shadow-sm flex items-center gap-2">
                            <i className="ph ph-arrow-counter-clockwise text-lg"></i> é‡å¯« Reset
                        </button>
                    </div>
                </div>
            );
        };

        const SentencePractice = ({ sentenceData, onComplete, handleBack }) => {
            const [chunkIndex, setChunkIndex] = useState(0);
            const fullText = sentenceData.content;
            const chunkSize = 4;
            const totalChunks = Math.ceil(fullText.length / chunkSize);
            const currentChunkText = fullText.slice(chunkIndex * chunkSize, (chunkIndex + 1) * chunkSize);
            const currentChars = currentChunkText.split('');
            const [completedCountInChunk, setCompletedCountInChunk] = useState(0);
            
            // æ–°å¢ï¼šå¥å­åˆ†æ•¸è¿½è¹¤
            // chunkScores æ˜¯ä¸€å€‹ ref é™£åˆ—ï¼Œç”¨ä¾†å„²å­˜æ¯ä¸€çµ„ (chunk) çš„å¹³å‡åˆ†
            // ç”±æ–¼ sentence åˆ†æ®µé€²è¡Œï¼Œæˆ‘å€‘éœ€è¦å°‡åˆ†æ•¸ç´¯åŠ èµ·ä¾†
            const chunkScoresRef = useRef([]);
            // ç•¶å‰é€™çµ„çš„å³æ™‚åˆ†æ•¸ (key: index in chunk, value: score)
            const [currentChunkScores, setCurrentChunkScores] = useState({});

            // æ¯æ¬¡æ›çµ„æ™‚é‡ç½®
            useEffect(() => { 
                setCompletedCountInChunk(0); 
                setCurrentChunkScores({}); // é‡ç½®ç•¶å‰çµ„åˆ†æ•¸
            }, [chunkIndex]);

            const handleChunkCharComplete = () => { setCompletedCountInChunk(prev => prev + 1); };
            
            // æ”¶é›†åˆ†æ•¸
            const handleScoreChange = (idxInChunk, score) => {
                setCurrentChunkScores(prev => ({ ...prev, [idxInChunk]: score }));
            };

            const calculateCurrentChunkAverage = () => {
                // å¦‚æœé€™çµ„æœ‰ 4 å€‹å­—ï¼Œå³ä½¿åªå¯«äº† 3 å€‹ï¼Œæœªå¯«çš„é è¨­ä¸ç®—åˆ†æˆ–ç®— 100? 
                // é‚è¼¯ï¼šé€™è£¡æˆ‘å€‘åªè¨ˆç®—ã€Œæœ‰å¯«éã€çš„å­—çš„å¹³å‡ï¼Œæˆ–è€…é è¨­æ¨™é»ç¬¦è™Ÿ 100 åˆ†ã€‚
                // ç‚ºäº†ç°¡åŒ–ï¼šæˆ‘å€‘å‡è¨­æ¨™é»ç¬¦è™Ÿå’Œæœªå¯«éŒ¯çš„å­—éƒ½æ˜¯ 100 åˆ†ã€‚
                // é€™è£¡çš„ currentChars åŒ…å«äº†æ¨™é»ã€‚æ¨™é»åœ¨ CharacterBox è£¡ä¸æœƒè§¸ç™¼ onScoreChange (é™¤éæˆ‘å€‘æ”¹å¯«)ï¼Œ
                // ä½†æ¨™é»æœƒè‡ªå‹• onCompleteã€‚
                // ç°¡å–®ç®—æ³•ï¼šé è¨­å…¨ 100ï¼Œæœ‰éŒ¯æ‰£åˆ†ã€‚
                // æˆ‘å€‘æ ¹æ“š currentChunkScores ä¾†æ‰£åˆ†ã€‚åˆå§‹åˆ†æ•¸ç¸½å’Œ = chars * 100ã€‚
                // ç¸½åˆ† = (chars * 100) - (ç¸½æ‰£åˆ†)ã€‚
                // å…¶å¯¦ç”¨ average æœ€æº–ã€‚
                
                // æ›´å¥½çš„æ–¹æ³•ï¼š
                // æ¯å€‹å­—é è¨­ 100ã€‚
                // currentChunkScores ç´€éŒ„äº†ã€Œè¢«æ‰£åˆ†å¾Œçš„å­—ã€çš„åˆ†æ•¸ã€‚
                // å°æ–¼æ²’åœ¨ currentChunkScores è£¡çš„å­—ï¼ˆåŒ…æ‹¬æ¨™é»ï¼‰ï¼Œåˆ†æ•¸æ˜¯ 100ã€‚
                
                let totalScore = 0;
                currentChars.forEach((_, idx) => {
                    const s = currentChunkScores[idx] !== undefined ? currentChunkScores[idx] : 100;
                    totalScore += s;
                });
                
                return currentChars.length > 0 ? Math.round(totalScore / currentChars.length) : 100;
            };

            const nextChunk = () => {
                // 1. è¨ˆç®—ä¸¦å„²å­˜é€™ä¸€çµ„çš„åˆ†æ•¸
                const chunkAvg = calculateCurrentChunkAverage();
                chunkScoresRef.current.push(chunkAvg);

                if (chunkIndex < totalChunks - 1) {
                    setChunkIndex(chunkIndex + 1);
                } else {
                    // 2. è¨ˆç®—æ•´å¥ç¸½å¹³å‡åˆ†
                    const finalTotal = chunkScoresRef.current.reduce((a, b) => a + b, 0);
                    const finalAvg = Math.round(finalTotal / chunkScoresRef.current.length);
                    // 3. å‚³éçµ¦ onComplete
                    onComplete(finalAvg);
                }
            };

            const prevChunk = () => { 
                if (chunkIndex > 0) {
                    // å›ä¸Šä¸€é æ™‚ï¼Œç§»é™¤æœ€å¾Œä¸€çµ„çš„åˆ†æ•¸ç´€éŒ„ï¼Œè®“å­¸ç”Ÿé‡å¯«é‡ç®—
                    chunkScoresRef.current.pop();
                    setChunkIndex(chunkIndex - 1); 
                }
            };
            const isChunkComplete = completedCountInChunk >= currentChars.length;

            return (
                <div className="h-full flex flex-col items-center justify-between py-2 overflow-hidden">
                    <div className="bg-white p-4 rounded-2xl shadow-sm border-2 border-sky-200 w-full text-center relative mb-2 shrink-0">
                        <div className="absolute top-2 right-2 flex gap-2">
                             <button onClick={() => speak(currentChunkText, 'zh-HK')} className="p-2 rounded-full bg-indigo-50 text-indigo-500 hover:bg-indigo-100"><span className="text-xs font-bold">ç²µ</span> ğŸ”Š</button>
                             <button onClick={() => speak(currentChunkText, 'zh-CN')} className="p-2 rounded-full bg-rose-50 text-rose-500 hover:bg-rose-100"><span className="text-xs font-bold">æ™®</span> ğŸ”Š</button>
                        </div>
                        <h3 className="text-sm font-bold text-gray-400 mb-1">å¥å­é è¦½</h3>
                        <p className="text-lg text-gray-700 leading-relaxed px-2 truncate">
                            {fullText.split('').map((char, i) => {
                                const isCurrent = i >= chunkIndex * chunkSize && i < (chunkIndex + 1) * chunkSize;
                                return <span key={i} className={`${isCurrent ? 'text-sky-600 font-bold bg-sky-100 rounded px-0.5' : (i < chunkIndex * chunkSize ? 'text-green-500' : 'text-gray-300')}`}>{char}</span>;
                            })}
                        </p>
                    </div>

                    <div className="flex-1 flex flex-col justify-center w-full min-h-0">
                        <div className="text-center mb-2 text-sky-600 font-bold text-sm">çµ„åˆ¥ï¼š{chunkIndex + 1} / {totalChunks}</div>
                        <div className="flex justify-center gap-1 md:gap-3">
                            {currentChars.map((char, idx) => (
                                <CharacterBox 
                                    key={`chunk-${chunkIndex}-${idx}`} 
                                    char={char} 
                                    onScoreChange={(char, score) => handleScoreChange(idx, score)} 
                                    resetSignal={0} 
                                    onComplete={handleChunkCharComplete} 
                                    sizeOverride={window.innerWidth < 640 ? 60 : 100} 
                                />
                            ))}
                        </div>
                    </div>

                    <div className="flex gap-4 w-full mt-2 shrink-0">
                        <button onClick={prevChunk} disabled={chunkIndex === 0} className={`flex-1 py-3 rounded-xl font-bold ${chunkIndex === 0 ? 'bg-gray-200 text-gray-400' : 'bg-white border-2 border-gray-200 text-gray-600'}`}>ä¸Šä¸€çµ„</button>
                        <button onClick={nextChunk} disabled={!isChunkComplete} className={`flex-1 py-3 rounded-xl font-bold shadow-md transition ${isChunkComplete ? 'bg-sky-500 text-white hover:bg-sky-600' : 'bg-gray-200 text-gray-400'}`}>{chunkIndex === totalChunks - 1 ? 'å®Œæˆ Finish' : 'ä¸‹ä¸€çµ„ Next'}</button>
                    </div>
                </div>
            );
        };

        const IdiomPractice = ({ data, onExit }) => {
            const [step, setStep] = useState('learn');
            const [currentIdx, setCurrentIdx] = useState(0);
            const [score, setScore] = useState(0);
            const [quizFeedback, setQuizFeedback] = useState(null);

            const quizOptions = React.useMemo(() => {
                const item = data[currentIdx];
                if (!item) return [];
                let opts = data.filter(d => d.id !== item.id).sort(() => Math.random() - 0.5).slice(0, 3);
                opts.push(item);
                return opts.sort(() => Math.random() - 0.5);
            }, [currentIdx, data]);

            const playAudio = (text, type) => {
                const lang = type === 'cantonese' ? 'zh-HK' : 'zh-CN';
                speak(text, lang);
            };

            if (step === 'learn') {
                const item = data[currentIdx];
                return (
                    <div className="h-full flex flex-col bg-amber-50 rounded-xl overflow-hidden shadow-sm border border-amber-100">
                        <div className="p-3 bg-white border-b border-amber-100 flex justify-between items-center shrink-0">
                             <button onClick={onExit} className="p-2 rounded-full hover:bg-amber-100 text-amber-600 transition"><i className="ph ph-arrow-left text-2xl"></i></button>
                             <h3 className="font-bold text-amber-800 text-lg">ğŸ“– æˆèªå­¸ç¿’ ({currentIdx + 1}/{data.length})</h3>
                        </div>
                        <div className="flex-1 p-4 flex flex-col items-center justify-center text-center overflow-hidden">
                            <div className="flex-1 flex flex-col justify-center w-full max-w-2xl overflow-y-auto no-scrollbar">
                                <h1 className="text-4xl md:text-5xl font-bold text-amber-900 mb-2">{item.word}</h1>
                                <div className="flex gap-2 mb-4 justify-center">
                                    <button onClick={() => playAudio(item.word, 'cantonese')} className="px-3 py-1 bg-indigo-100 text-indigo-600 rounded-full text-sm font-bold flex items-center gap-1">ç²µ {item.jyutping} ğŸ”Š</button>
                                    <button onClick={() => playAudio(item.word, 'mandarin')} className="px-3 py-1 bg-rose-100 text-rose-600 rounded-full text-sm font-bold flex items-center gap-1">æ™® {item.pinyin} ğŸ”Š</button>
                                </div>
                                <div className="bg-white p-4 rounded-2xl shadow-sm border-2 border-amber-100 w-full space-y-3 text-left">
                                    <div><span className="text-xs font-bold text-gray-400 uppercase">Meaning</span><p className="text-lg text-gray-800">{item.meaning}</p></div>
                                    <div className="border-t border-gray-100 pt-2"><span className="text-xs font-bold text-gray-400 uppercase">English</span><p className="text-md text-amber-700 font-serif italic">{item.english_meaning}</p></div>
                                    <div className="bg-amber-50 p-3 rounded-lg border border-amber-200"><span className="text-xs font-bold text-amber-400 uppercase">Example</span><p className="text-md text-gray-700">{item.sentence}</p></div>
                                </div>
                            </div>
                        </div>
                        <div className="p-4 bg-white border-t border-amber-100 flex justify-between shrink-0">
                            <button onClick={() => setCurrentIdx(Math.max(0, currentIdx - 1))} disabled={currentIdx === 0} className="px-6 py-3 rounded-xl bg-gray-100 text-gray-500 font-bold disabled:opacity-50">ä¸Šä¸€å€‹</button>
                            <button onClick={() => { if (currentIdx < data.length - 1) setCurrentIdx(currentIdx + 1); else { setCurrentIdx(0); setScore(0); setStep('quiz'); } }} className="px-6 py-3 rounded-xl bg-amber-500 text-white font-bold shadow-lg hover:bg-amber-600">{currentIdx === data.length - 1 ? 'é–‹å§‹æ¸¬é©— Quiz' : 'ä¸‹ä¸€å€‹'}</button>
                        </div>
                    </div>
                );
            }

            if (step === 'quiz') {
                const item = data[currentIdx];
                return (
                    <div className="h-full flex flex-col bg-purple-50 rounded-xl overflow-hidden shadow-sm border border-purple-100">
                        <div className="p-4 bg-white border-b border-purple-100 flex justify-between items-center shrink-0">
                             <button onClick={onExit} className="p-2 rounded-full hover:bg-purple-100 text-purple-600 transition"><i className="ph ph-arrow-left text-2xl"></i></button>
                             <span className="font-bold text-purple-800">ğŸ¯ æˆèªå¡«ç©º ({currentIdx + 1}/{data.length})</span>
                             <span className="font-bold text-purple-600 bg-purple-100 px-3 py-1 rounded-full">ç›®å‰å¾—åˆ†: {score}</span>
                        </div>
                        <div className="flex-1 p-6 flex flex-col items-center justify-center overflow-hidden">
                             <div className="w-full max-w-md flex flex-col gap-4 overflow-y-auto no-scrollbar">
                                 <div className="bg-white p-6 rounded-2xl shadow-md border-2 border-purple-200 text-center">
                                     <h3 className="text-xl text-gray-700 leading-loose">{item.sentence.replace('____', '______')}</h3>
                                     <p className="text-sm text-gray-400 mt-4">(Hint: {item.english_meaning})</p>
                                 </div>
                                 <div className="grid grid-cols-1 gap-2 w-full">
                                     {quizOptions.map(opt => (
                                         <button key={opt.id} onClick={() => {
                                             if (quizFeedback) return;
                                             if (opt.id === item.id) { setScore(s => s + 20); setQuizFeedback('correct'); } else { setQuizFeedback('wrong'); }
                                             setTimeout(() => { setQuizFeedback(null); if (currentIdx < data.length - 1) setCurrentIdx(currentIdx + 1); else setStep('result'); }, 1500);
                                         }} disabled={!!quizFeedback} className={`p-3 rounded-xl border-2 font-bold text-lg transition ${quizFeedback ? (opt.id === item.id ? 'bg-emerald-500 border-emerald-500 text-white' : (opt.word === quizFeedback ? 'bg-red-500 text-white' : 'bg-gray-50 text-gray-300')) : 'bg-white border-purple-100 text-purple-900 hover:bg-purple-100 hover:border-purple-300'}`}>{opt.word}</button>
                                     ))}
                                 </div>
                             </div>
                        </div>
                    </div>
                );
            }

            if (step === 'result') {
                let encourageText = score === 100 ? "å¤ªå²å®³äº†ï¼æˆèªå¤§å¸«ï¼ğŸŒŸ" : (score >= 60 ? "åšå¾—å¾ˆå¥½ï¼ç¹¼çºŒä¿æŒï¼ğŸ’ª" : "åˆ¥æ°£é¤’ï¼Œå†æ¥å†å²ï¼ğŸ“š");
                return (
                    <div className="h-full flex flex-col items-center justify-center bg-yellow-50 p-6 text-center animate-bounce-in relative">
                        <div className="absolute top-4 left-4">
                            <button onClick={onExit} className="p-2 rounded-full bg-white/50 hover:bg-white text-gray-600 transition shadow-sm"><i className="ph ph-arrow-left text-2xl"></i></button>
                        </div>
                        <div className="text-8xl mb-4">ğŸ†</div>
                        <h2 className="text-3xl font-bold text-yellow-800 mb-2">æ¸¬é©—å®Œæˆï¼</h2>
                        <div className="text-6xl font-bold text-orange-500 mb-6">ç¸½åˆ†ï¼š{score} / 100</div>
                        <p className="text-gray-600 text-lg mb-8 max-w-xs mx-auto">{encourageText}</p>
                        <button onClick={onExit} className="px-8 py-4 bg-yellow-500 text-white text-xl font-bold rounded-2xl shadow-lg hover:bg-yellow-600 transition transform active:scale-95">å®Œæˆä¸¦é€€å‡º</button>
                    </div>
                );
            }
        };

        const App = () => {
            const [playerName, setPlayerName] = useState('');
            const [inputName, setInputName] = useState('');
            const [navPath, setNavPath] = useState([]);
            const [activeFile, setActiveFile] = useState(null); 
            const [mode, setMode] = useState('welcome'); 
            const [currentIndex, setCurrentIndex] = useState(0);
            const [score, setScore] = useState(0);
            const [showResult, setShowResult] = useState(false);
            const [feedback, setFeedback] = useState(null); 
            const [quizOptions, setQuizOptions] = useState([]);
            const [canProceed, setCanProceed] = useState(false);
            const [studyScores, setStudyScores] = useState([]);
            const [currentWordScore, setCurrentWordScore] = useState(100);
            const [showStudyResult, setShowStudyResult] = useState(false);
            
            // Score for Sentence Practice result page
            const [sentenceFinalScore, setSentenceFinalScore] = useState(0);

            const playAudio = (text, type) => {
                const lang = type === 'cantonese' ? 'zh-HK' : 'zh-CN';
                speak(text, lang);
            };

            const handleLogin = (e) => {
                e.preventDefault();
                if (inputName.trim()) { setPlayerName(inputName.trim()); setMode('browser'); setNavPath([FILE_SYSTEM.children[0]]); }
            };

            const currentFolder = navPath.length > 0 ? navPath[navPath.length - 1] : FILE_SYSTEM;
            const handleEnterFolder = (folder) => { if (folder.children.length === 0) { alert("æ­¤è³‡æ–™å¤¾æš«æ™‚ç‚ºç©ºï¼Œè«‹é¸æ“‡å…¶ä»–ã€‚"); return; } setNavPath([...navPath, folder]); };
            const handleOpenFile = (file) => { setActiveFile(file); if (file.fileType === 'vocab') setMode('menu'); else if (file.fileType === 'sentence') startStudy(file); else if (file.fileType === 'idiom') setMode('idiom'); };
            const handleBack = () => { if (mode === 'browser') { if (navPath.length > 1) setNavPath(navPath.slice(0, -1)); else setMode('welcome'); } else { setMode('browser'); setActiveFile(null); } };

            const startStudy = (fileOverride = null) => {
                const target = fileOverride || activeFile;
                setActiveFile(target); setMode('study'); setCurrentIndex(0); setCanProceed(false); setStudyScores([]); setCurrentWordScore(100); setShowStudyResult(false); setSentenceFinalScore(0);
            };

            const startQuiz = () => {
                setMode('quiz'); setScore(0); setCurrentIndex(0); setShowResult(false); prepareQuizRound(0);
            };

            const prepareQuizRound = (index) => {
                const vocabList = activeFile.data;
                if (index >= vocabList.length) { setShowResult(true); return; }
                const correctWord = vocabList[index];
                let options = vocabList.filter(v => v.id !== correctWord.id);
                options = options.sort(() => Math.random() - 0.5).slice(0, 3);
                options.push(correctWord);
                setQuizOptions(options.sort(() => Math.random() - 0.5));
            };

            const handleQuizAnswer = (selectedWord) => {
                const currentWord = activeFile.data[currentIndex];
                if (selectedWord.id === currentWord.id) { setScore(score + 10); setFeedback('correct'); } else { setFeedback('wrong'); }
                setTimeout(() => { setFeedback(null); const nextIndex = currentIndex + 1; setCurrentIndex(nextIndex); prepareQuizRound(nextIndex); }, 1000);
            };

            if (mode === 'welcome') {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-4">
                        <div className="bg-white/80 backdrop-blur-md p-8 rounded-3xl shadow-xl w-full max-w-sm border-4 border-rose-200">
                            <div className="w-32 h-32 bg-rose-100 rounded-full mx-auto mb-4 flex items-center justify-center overflow-hidden border-4 border-rose-300 shadow-inner relative group">
                                <img src="profile.jpg" onError={(e) => { e.target.style.display = 'none'; e.target.nextSibling.style.display = 'block'; }} className="w-full h-full object-cover" alt="Ms. Ni" />
                                <span className="text-5xl absolute" style={{display: 'none'}}>ğŸ‘©â€ğŸ«</span>
                            </div>
                            <h1 className="text-3xl text-rose-900 text-center mb-1 font-bold">Ms. Ni çš„ä¸­æ–‡èª²å ‚</h1>
                            <h3 className="text-xl text-rose-600 font-bold text-center mb-6">P6A ç­</h3>
                            <form onSubmit={handleLogin} className="space-y-4">
                                <input type="text" value={inputName} onChange={(e) => setInputName(e.target.value)} placeholder="è¼¸å…¥ä½ çš„åå­—" className="w-full px-4 py-3 text-lg rounded-2xl border-2 border-rose-100 focus:outline-none focus:border-rose-400 bg-white text-center transition" required />
                                <button type="submit" className="w-full bg-rose-400 text-white text-xl py-3 rounded-2xl font-bold shadow-md hover:bg-rose-500 active:scale-95 transition">é–‹å§‹ä¸Šèª² Start</button>
                            </form>
                        </div>
                    </div>
                );
            }

            if (mode === 'idiom') return <div className="h-screen w-screen flex flex-col p-4 bg-rose-50/50 overflow-hidden"><IdiomPractice data={activeFile.data} onExit={handleBack} /></div>;

            if (mode === 'browser') {
                return (
                    <div className="h-screen w-screen flex flex-col bg-sky-50 overflow-hidden">
                        <div className="bg-white/80 backdrop-blur-md shadow-sm px-4 py-4 sticky top-0 z-10 border-b border-rose-100 shrink-0">
                            <div className="flex justify-between items-center max-w-3xl mx-auto">
                                <div className="flex items-center gap-2">
                                    <button onClick={handleBack} className="mr-2 p-1 rounded hover:bg-rose-50"><i className={`ph ${navPath.length > 0 ? 'ph-arrow-left text-rose-500' : 'ph-house text-rose-300'} text-2xl`}></i></button>
                                    <h2 className="text-xl font-bold text-rose-900">{navPath.length > 0 ? navPath[navPath.length-1].title : "æˆ‘çš„èª²å ‚"}</h2>
                                </div>
                                <span className="text-sm font-bold text-rose-600 bg-rose-100 px-4 py-1.5 rounded-full border border-rose-200">å­¸ç”Ÿï¼š{playerName}</span>
                            </div>
                        </div>
                        <div className="max-w-3xl mx-auto w-full px-4 py-2 flex items-center gap-2 text-sm text-gray-400 overflow-x-auto shrink-0">
                            {navPath.map((folder, idx) => (
                                <React.Fragment key={folder.id}>
                                    <span onClick={() => setNavPath(navPath.slice(0, idx + 1))} className={`cursor-pointer whitespace-nowrap ${idx === navPath.length - 1 ? 'font-bold text-rose-600' : 'hover:text-rose-400'}`}>{folder.title}</span>
                                    {idx < navPath.length - 1 && <i className="ph ph-caret-right"></i>}
                                </React.Fragment>
                            ))}
                        </div>
                        <div className="flex-1 p-4 overflow-y-auto">
                            <div className="max-w-3xl mx-auto grid grid-cols-1 sm:grid-cols-2 gap-4 animate-bounce-in">
                                {currentFolder.children.map(item => (
                                    <button key={item.id} onClick={() => item.type === 'folder' ? handleEnterFolder(item) : handleOpenFile(item)} className={`p-6 rounded-3xl shadow-sm border-2 text-left flex flex-col gap-2 transition transform hover:scale-[1.02] active:scale-95 ${item.type === 'folder' ? 'bg-white border-rose-200 text-rose-800' : 'bg-white border-sky-200 text-sky-900'} ${item.children && item.children.length === 0 && item.type === 'folder' ? 'opacity-60 cursor-not-allowed grayscale' : ''}`}>
                                        <div className="flex justify-between items-start"><div className={`p-3 rounded-2xl ${item.type === 'folder' ? 'bg-rose-100 text-rose-500' : 'bg-sky-100 text-sky-500'}`}><i className={`ph ${item.icon} text-3xl`}></i></div></div>
                                        <div><h3 className="text-xl font-bold">{item.title}</h3>{item.subtitle && <p className="text-sm opacity-60 mt-1">{item.subtitle}</p>}</div>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }

            if (mode === 'menu') {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-4">
                        <div className="bg-white/90 backdrop-blur p-8 rounded-3xl shadow-xl w-full max-w-md border-2 border-rose-100 animate-bounce-in relative">
                            <button onClick={handleBack} className="absolute top-4 left-4 p-2 rounded-full bg-gray-100 text-gray-400 hover:bg-gray-200 transition"><i className="ph ph-arrow-left text-2xl"></i></button>
                            <div className="text-center mb-8 mt-4">
                                <div className="inline-block p-4 bg-sky-100 rounded-full text-sky-500 mb-4 shadow-sm"><i className="ph ph-file-text text-4xl"></i></div>
                                <h1 className="text-2xl font-bold text-gray-800">{activeFile.title}</h1>
                                <p className="text-gray-500">è«‹é¸æ“‡å­¸ç¿’æ¨¡å¼</p>
                            </div>
                            <div className="space-y-4">
                                <button onClick={() => startStudy()} className="w-full bg-sky-400 text-white text-xl py-4 rounded-2xl shadow-lg active:scale-95 font-bold flex items-center justify-center gap-3 hover:bg-sky-500 transition"><i className="ph ph-pencil-simple text-2xl"></i> å¯«å­—ç·´ç¿’ Writing</button>
                                <button onClick={startQuiz} className="w-full bg-emerald-400 text-white text-xl py-4 rounded-2xl shadow-lg active:scale-95 font-bold flex items-center justify-center gap-3 hover:bg-emerald-500 transition"><i className="ph ph-game-controller text-2xl"></i> è©ç¾©æ¸¬é©— Quiz</button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (mode === 'study') {
                const isSentence = activeFile.fileType === 'sentence';
                if (isSentence) {
                    const sentenceData = activeFile.data;
                    return (
                        <div className="h-screen w-screen flex flex-col bg-slate-50 overflow-hidden">
                            <div className="flex justify-between items-center px-4 py-3 bg-white/90 backdrop-blur shadow-sm shrink-0 z-20">
                                <button onClick={handleBack} className="flex items-center gap-1 text-rose-500 font-bold hover:bg-rose-50 px-3 py-1 rounded-full transition"><i className="ph ph-caret-left font-bold"></i> é€€å‡º</button>
                                <span className="text-lg font-bold text-gray-700">å¥å­æç´…</span>
                                <div className="w-10"></div>
                            </div>
                            <div className="flex-1 p-2 flex flex-col items-center justify-center overflow-hidden">
                                <div className="w-full max-w-4xl h-full flex flex-col">
                                    <SentencePractice 
                                        sentenceData={sentenceData} 
                                        onComplete={(avgScore) => { 
                                            setSentenceFinalScore(avgScore);
                                            setShowStudyResult(true); 
                                        }} 
                                        handleBack={handleBack} 
                                    />
                                </div>
                            </div>
                        </div>
                    );
                }

                if (showStudyResult) {
                    // Check if it's sentence result
                    let finalScore = 0;
                    if (activeFile.fileType === 'sentence') {
                        finalScore = sentenceFinalScore;
                    } else {
                        const totalSum = studyScores.reduce((acc, curr) => acc + curr, 0);
                        finalScore = studyScores.length > 0 ? Math.round(totalSum / studyScores.length) : 0;
                    }
                    
                    let encourageText = "";
                    if (finalScore >= 100) encourageText = "å®Œç¾ç„¡ç‘•ï¼ä½ æ˜¯å¯«å­—å°ç¥ç«¥ï¼ğŸŒŸ";
                    else if (finalScore >= 90) encourageText = "å¤ªæ£’äº†ï¼å­—è·¡å„ªç¾ï¼Œç¹¼çºŒä¿æŒï¼ğŸ‰";
                    else if (finalScore >= 80) encourageText = "å¯«å¾—ä¸éŒ¯ï¼å†æ¥å†å²ï¼ğŸ’ª";
                    else if (finalScore >= 60) encourageText = "åŠ æ²¹ï¼å¤šç·´ç¿’æœƒå¯«å¾—æ›´æ¼‚äº®ï¼âœï¸";
                    else encourageText = "åˆ¥ç°å¿ƒï¼Œæ…¢æ…¢å¯«ï¼Œä½ æœƒé€²æ­¥çš„ï¼ğŸŒ±";

                    return (
                        <div className="min-h-screen flex flex-col items-center justify-center p-4 bg-sky-50 relative">
                            <div className="absolute top-4 left-4">
                                <button onClick={() => setMode('browser')} className="p-2 rounded-full bg-white/50 hover:bg-white text-gray-600 transition shadow-sm"><i className="ph ph-arrow-left text-2xl"></i></button>
                            </div>
                            <div className="bg-white p-8 rounded-3xl shadow-xl text-center w-full max-w-md border-4 border-sky-200 animate-bounce-in">
                                <h2 className="text-2xl font-bold text-gray-800 mb-2">ç·´ç¿’å®Œæˆï¼</h2>
                                <p className="text-lg text-sky-600 font-bold mb-6">{playerName}</p>
                                <div className="mb-8"><div className="text-7xl mb-4">ğŸ“</div><div className="text-5xl font-bold text-sky-500 mb-2">{finalScore} åˆ†</div><div className="text-gray-400 text-sm">ç¸½åˆ†ï¼š100</div></div>
                                <div className="bg-sky-50 p-4 rounded-xl mb-8"><p className="text-sky-800 font-bold text-lg">{encourageText}</p></div>
                                <button onClick={() => setMode('browser')} className="w-full bg-sky-400 text-white text-xl py-4 rounded-2xl font-bold shadow-lg transform transition active:scale-95 hover:bg-sky-500">è¿”å›ç›®éŒ„</button>
                            </div>
                        </div>
                    );
                }

                const vocabList = activeFile.data;
                const wordData = vocabList[currentIndex];
                return (
                    <div className="h-screen w-screen flex flex-col bg-slate-50 overflow-hidden">
                        <div className="flex justify-between items-center px-4 py-3 bg-white/90 backdrop-blur shadow-sm shrink-0 z-20">
                            <button onClick={() => setMode('menu')} className="p-2 rounded-full hover:bg-rose-100 text-rose-500 transition"><i className="ph ph-arrow-left text-2xl"></i></button>
                            <span className="text-xl font-bold text-gray-600 bg-gray-100 px-4 py-1 rounded-full tracking-widest">{currentIndex + 1} / {vocabList.length}</span>
                            <div className="w-20"></div>
                        </div>
                        
                        <div className="flex-1 p-4 overflow-hidden flex flex-col md:flex-row gap-4">
                            <div className="flex-1 bg-white rounded-3xl shadow-sm border border-rose-100 p-4 md:p-6 flex flex-col justify-center gap-4 overflow-y-auto no-scrollbar">
                                <div className="flex flex-col items-center md:items-start text-center md:text-left gap-2">
                                    <div className="flex items-center gap-4 flex-wrap justify-center md:justify-start">
                                        <h2 className="text-5xl md:text-6xl font-bold text-gray-800 leading-tight">{wordData.word}</h2>
                                        <div className="flex gap-2">
                                            <button onClick={() => playAudio(wordData.word, 'cantonese')} className="px-3 py-2 rounded-xl bg-indigo-50 text-indigo-600 hover:bg-indigo-100 transition font-bold flex items-center gap-1 border border-indigo-100">ç²µ <i className="ph ph-speaker-high"></i></button>
                                            <button onClick={() => playAudio(wordData.word, 'mandarin')} className="px-3 py-2 rounded-xl bg-rose-50 text-rose-600 hover:bg-rose-100 transition font-bold flex items-center gap-1 border border-rose-100">æ™® <i className="ph ph-speaker-high"></i></button>
                                        </div>
                                    </div>
                                    <div className="flex gap-3 mt-2 flex-wrap justify-center md:justify-start">
                                        <span className="text-sm font-bold text-indigo-700 bg-indigo-50 px-3 py-1 rounded-lg border border-indigo-100">ç²µ: {wordData.jyutping}</span>
                                        <span className="text-sm font-bold text-rose-700 bg-rose-50 px-3 py-1 rounded-lg border border-rose-100">æ™®: {wordData.pinyin}</span>
                                    </div>
                                </div>
                                <div className="space-y-3 w-full">
                                    <div className="bg-gray-50 p-4 rounded-xl border border-gray-100"><span className="font-bold block text-xs text-gray-400 uppercase tracking-wider">Meaning</span><p className="text-lg text-gray-700 font-bold">{wordData.meaning}</p></div>
                                    <div className="bg-sky-50 p-4 rounded-xl border border-sky-100"><span className="font-bold block text-xs text-sky-300 uppercase tracking-wider">English</span><p className="text-base text-sky-700 font-serif">{wordData.english_meaning}</p></div>
                                    {wordData.tip && <div className="bg-amber-50 p-3 rounded-xl border border-amber-100 flex items-start gap-2 text-amber-800 text-sm"><i className="ph ph-lightbulb text-xl shrink-0 text-amber-500"></i><span className="mt-0.5">{wordData.tip}</span></div>}
                                </div>
                            </div>
                            <div className="flex-1 bg-white rounded-3xl shadow-sm border border-slate-100 p-2 flex flex-col justify-center relative overflow-hidden">
                                <WordPractice key={wordData.id} wordData={wordData} onWordComplete={setCanProceed} onScoreUpdate={(score) => setCurrentWordScore(score)} />
                            </div>
                        </div>

                        <div className="shrink-0 p-4 bg-white/90 backdrop-blur border-t border-rose-100 flex justify-between items-center gap-4 z-20 shadow-[0_-4px_15px_-5px_rgba(0,0,0,0.05)]">
                            <button onClick={() => setCurrentIndex(Math.max(0, currentIndex - 1))} disabled={currentIndex === 0} className={`px-6 py-3 rounded-xl font-bold text-lg transition flex items-center gap-2 ${currentIndex === 0 ? 'bg-gray-100 text-gray-300' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}><i className="ph ph-caret-left font-bold text-xl"></i> ä¸Šä¸€å€‹</button>
                            <button onClick={() => { const newScores = [...studyScores, currentWordScore]; setStudyScores(newScores); if (currentIndex < vocabList.length - 1) { setCurrentIndex(currentIndex + 1); setCanProceed(false); setCurrentWordScore(100); } else { setShowStudyResult(true); } }} disabled={!canProceed} className={`flex-1 py-3 rounded-xl font-bold shadow-lg transition text-xl flex justify-center items-center gap-3 ${canProceed ? 'bg-rose-500 text-white hover:bg-rose-600 active:scale-95' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}`}>{!canProceed && <i className="ph ph-lock-key text-2xl"></i>} {currentIndex === vocabList.length - 1 ? 'å®Œæˆç·´ç¿’ Finish' : 'ä¸‹ä¸€å€‹ Next'} {canProceed && <i className="ph ph-caret-right font-bold text-2xl"></i>}</button>
                        </div>
                    </div>
                );
            }

            if (mode === 'quiz') {
                const vocabList = activeFile.data;
                if (showResult) {
                    const totalPossibleScore = vocabList.length * 10;
                    const percentage = (score / totalPossibleScore) * 100;
                    return (
                        <div className="min-h-screen flex flex-col items-center justify-center p-4 bg-emerald-50 relative">
                            <div className="absolute top-4 left-4">
                                <button onClick={() => setMode('menu')} className="p-2 rounded-full bg-white/50 hover:bg-white text-gray-600 transition shadow-sm"><i className="ph ph-arrow-left text-2xl"></i></button>
                            </div>
                            <div className="bg-white p-8 rounded-3xl shadow-xl text-center w-full max-w-md border-4 border-emerald-200 animate-bounce-in">
                                <h2 className="text-2xl font-bold text-gray-800 mb-2">æŒ‘æˆ°å®Œæˆï¼</h2>
                                <p className="text-lg text-emerald-600 font-bold mb-6">{playerName}</p>
                                <div className="mb-8 relative inline-block"><div className="text-8xl">{percentage >= 80 ? "ğŸ†" : (percentage >= 60 ? "ğŸ˜Š" : "ğŸ’ª")}</div></div>
                                <div className="text-5xl font-bold text-emerald-500 mb-2">{score} åˆ†</div>
                                <div className="text-gray-400 text-sm mb-8">æ»¿åˆ†ï¼š{totalPossibleScore}</div>
                                <button onClick={() => setMode('menu')} className="w-full bg-emerald-400 text-white text-xl py-4 rounded-2xl font-bold shadow-lg transform transition active:scale-95 hover:bg-emerald-500">è¿”å›ç›®éŒ„</button>
                            </div>
                        </div>
                    );
                }

                const currentWord = vocabList[currentIndex];
                return (
                    <div className="h-screen w-screen flex flex-col bg-slate-50 overflow-hidden">
                        <div className="flex justify-between items-center px-4 py-3 bg-white/80 backdrop-blur shadow-sm shrink-0 z-10">
                            <div className="flex items-center gap-3">
                                <button onClick={() => setMode('menu')} className="p-2 rounded-full hover:bg-gray-100 text-gray-500 transition"><i className="ph ph-arrow-left text-2xl"></i></button>
                                <span className="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-sm font-bold">Q {currentIndex + 1}</span>
                            </div>
                            <span className="font-bold text-emerald-600 bg-emerald-50 px-3 py-1 rounded-full border border-emerald-100">Score: {score}</span>
                        </div>
                        <div className="flex-1 flex flex-col items-center justify-center p-4 overflow-y-auto">
                            <div className="w-full max-w-md bg-white rounded-3xl shadow-lg p-6 border border-rose-100">
                                <h3 className="text-xl text-gray-800 leading-loose mb-4 text-center font-medium">{currentWord.sentence.split('____').map((part, i) => (<span key={i}>{part}{i === 0 && <span className="inline-block w-20 border-b-2 border-orange-400 mx-1 text-center text-orange-400 font-bold">?</span>}</span>))}</h3>
                                <div className="bg-slate-50 p-3 rounded-xl mb-6 text-center border border-slate-100"><span className="text-xs text-gray-400 uppercase font-bold block mb-1">English Hint</span><span className="text-slate-600">{currentWord.english_meaning}</span></div>
                                <div className="grid grid-cols-1 gap-3">
                                    {quizOptions.map((option) => (
                                        <button key={option.id} onClick={() => !feedback && handleQuizAnswer(option)} disabled={!!feedback} className={`p-4 text-lg font-bold rounded-2xl border-2 transition flex items-center justify-between px-6 ${feedback ? (option.id === currentWord.id ? 'bg-emerald-400 border-emerald-400 text-white' : (option.word === feedback ? 'bg-red-100 border-red-200' : 'bg-gray-50 border-gray-100 text-gray-300')) : 'bg-white border-slate-100 text-slate-600 hover:border-sky-300 hover:bg-sky-50 shadow-sm'}`}>
                                            <span>{option.word}</span>{option.emoji && <span className="text-xl">{option.emoji}</span>}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }
            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>